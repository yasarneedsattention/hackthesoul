<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GLYPH-GRIND // FIXED</title>
    <style>
        :root {
            --bg: #E0E0E0;
            --gba-shell: #121212;
            --safety-orange: #FF4500;
            --industrial-yellow: #FFD700;
            --font: "Helvetica", Arial, sans-serif;
        }

        body, html {
            margin: 0; padding: 0;
            background: var(--bg);
            font-family: var(--font);
            display: flex; justify-content: center; align-items: center;
            height: 100vh; overflow: hidden;
            text-transform: uppercase;
        }

        #console {
            width: 95vw; max-width: 900px;
            aspect-ratio: 16/9;
            background: var(--gba-shell);
            border-radius: 40px;
            padding: 15px;
            display: grid;
            grid-template-columns: 1.2fr 3.5fr 1.2fr;
            align-items: center;
            box-shadow: 0 15px 0 #000;
        }

        #screen-container { background: #000; padding: 8px; border-radius: 10px; height: 90%; position: relative; }
        #game-viewport { width: 100%; height: 100%; background: #FFF; position: relative; overflow: hidden; }

        /* DESIGN LAB */
        #design-lab { position: absolute; inset: 0; background: #FFF; z-index: 100; display: flex; flex-direction: column; padding: 10px; }
        .mod-scroll { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; overflow-y: auto; flex-grow: 1; }
        .mod-option { border: 2px solid #000; padding: 8px; font-size: 10px; font-weight: 900; cursor: pointer; text-align: center; background: #EEE; }
        .mod-option:active { background: var(--industrial-yellow); }

        /* CHARACTER PIECES */
        .player { position: absolute; bottom: 0; width: 60px; height: 100px; display: flex; flex-direction: column; align-items: center; pointer-events: none; }
        .ears { display: none; width: 100%; justify-content: space-between; position: absolute; top: -15px; }
        .ear { width: 15px; height: 25px; background: #000; clip-path: polygon(50% 0%, 0% 100%, 100% 100%); }
        .head { width: 45px; height: 45px; background: #000; border-radius: 40%; position: relative; border: 2px solid #000; display: flex; justify-content: center; align-items: center; }
        .teeth { display: none; width: 30px; height: 10px; background: #FFF; clip-path: polygon(0 0, 20% 100%, 40% 0, 60% 100%, 80% 0, 100% 100%, 100% 0); margin-top: 15px; }
        .body-block { width: 50px; height: 40px; background: #000; margin-top: 2px; position: relative; color: #FFF; display: flex; justify-content: center; align-items: center; font-size: 8px; font-weight: 900; }
        .zip-tie { display: none; width: 25px; height: 6px; background: var(--safety-orange); position: absolute; right: -15px; top: 5px; }
        .belt { display: none; width: 110%; height: 8px; background: var(--industrial-yellow); position: absolute; top: 15px; transform: rotate(-5deg); }

        /* HUD */
        #hud { position: absolute; top: 5px; width: 100%; display: none; justify-content: space-between; padding: 0 10px; z-index: 50; }
        .hp-cont { width: 80px; height: 10px; border: 2px solid #000; background: #EEE; }
        .hp-val { height: 100%; background: #000; width: 100%; transition: width 0.1s; }

        /* BUTTONS */
        .d-pad { display: grid; grid-template-columns: repeat(3, 40px); grid-template-rows: repeat(3, 40px); }
        .d-btn { background: #222; border-radius: 5px; display: flex; justify-content: center; align-items: center; color: #FFF; font-size: 10px; cursor: pointer; }
        .a-b-btn { width: 55px; height: 55px; border-radius: 50%; background: #333; color: #FFF; display: flex; justify-content: center; align-items: center; font-weight: 900; cursor: pointer; box-shadow: 0 4px 0 #000; margin-bottom: 10px; }
        .a-btn { background: var(--safety-orange); }

        /* VFX */
        .attacking { filter: drop-shadow(0 0 5px var(--safety-orange)) !important; transform: scale(1.1) !important; }
        .hit { animation: hit-flash 0.1s; }
        @keyframes hit-flash { from { background: red; } to { background: white; } }

        @media (max-width: 600px) {
            #console { grid-template-columns: 1fr; grid-template-rows: 2fr 1fr; height: 95vh; }
            .side { display: flex; justify-content: space-around; width: 100%; }
        }
    </style>
</head>
<body>

<div id="console">
    <div class="side">
        <div class="d-pad">
            <div></div><div class="d-btn" id="ctrl-up">UP</div><div></div>
            <div class="d-btn" id="ctrl-left">L</div><div></div><div class="d-btn" id="ctrl-right">R</div>
        </div>
    </div>

    <div id="screen-container">
        <div id="game-viewport">
            <div id="hud">
                <div class="hp-cont"><div id="hp1" class="hp-val"></div></div>
                <div class="hp-cont"><div id="hp2" class="hp-val" style="background:var(--industrial-yellow)"></div></div>
            </div>

            <div id="design-lab">
                <div style="font-weight:900; border-bottom:3px solid #000; margin-bottom:10px;">DESIGN_LAB v1.0</div>
                <div id="preview-stage" style="height:110px; background:#f0f0f0; border:2px dashed #000; position:relative; display:flex; justify-content:center; align-items:center;">
                    <div id="main-player" class="player" style="position:relative;">
                        <div class="ears" id="m-ears"><div class="ear"></div><div class="ear"></div></div>
                        <div class="head" id="m-head"><div class="teeth" id="m-teeth"></div></div>
                        <div class="body-block" id="m-body">
                            "ITEM"
                            <div class="zip-tie" id="m-zip"></div>
                            <div class="belt" id="m-belt"></div>
                        </div>
                    </div>
                </div>
                <div class="mod-scroll">
                    <div class="mod-option" onclick="toggleMod('ears')">"EARS"</div>
                    <div class="mod-option" onclick="toggleMod('teeth')">"TEETH"</div>
                    <div class="mod-option" onclick="toggleMod('zip')">"ZIP-TIE"</div>
                    <div class="mod-option" onclick="toggleMod('belt')">"BELT"</div>
                </div>
                <button onclick="bootMatch()" style="background:#000; color:#FFF; border:none; padding:10px; font-weight:900; margin-top:5px;">START_MATCH</button>
            </div>

            <div id="p2" class="player" style="display:none; left:200px;">
                <div class="head" style="background:var(--industrial-yellow);"><div class="teeth" style="display:block;"></div></div>
                <div class="body-block" style="background:var(--industrial-yellow); color:#000;">"CPU"</div>
            </div>
        </div>
    </div>

    <div class="side">
        <div class="a-b-btn" id="ctrl-b">B</div>
        <div class="a-b-btn a-btn" id="ctrl-a">A</div>
    </div>
</div>

<script>
    const mods = { ears: false, teeth: false, zip: false, belt: false };
    const inputs = { left: false, right: false, up: false, a: false, b: false };
    const p1 = { x: 40, y: 0, vy: 0, hp: 100, isJump: false, isAtk: false, dir: 1, el: null };
    const p2 = { x: 220, y: 0, vy: 0, hp: 100, isJump: false, isAtk: false, dir: -1, el: null };
    let gameActive = false;

    function toggleMod(m) {
        mods[m] = !mods[m];
        document.getElementById(`m-${m}`).style.display = mods[m] ? (m === 'ears' ? 'flex' : 'block') : 'none';
    }

    function bind(id, key) {
        const el = document.getElementById(id);
        const start = (e) => { e.preventDefault(); inputs[key] = true; };
        const end = (e) => { e.preventDefault(); inputs[key] = false; };
        el.onmousedown = el.ontouchstart = start;
        el.onmouseup = el.ontouchend = end;
    }

    bind('ctrl-left', 'left'); bind('ctrl-right', 'right'); bind('ctrl-up', 'up');
    bind('ctrl-a', 'a'); bind('ctrl-b', 'b');

    // Keyboard Fallback
    window.onkeydown = (e) => {
        if(e.key === 'a' || e.key === 'ArrowLeft') inputs.left = true;
        if(e.key === 'd' || e.key === 'ArrowRight') inputs.right = true;
        if(e.key === 'w' || e.key === 'ArrowUp') inputs.up = true;
        if(e.key === 'k') inputs.a = true;
        if(e.key === 'j') inputs.b = true;
    };
    window.onkeyup = (e) => {
        if(e.key === 'a' || e.key === 'ArrowLeft') inputs.left = false;
        if(e.key === 'd' || e.key === 'ArrowRight') inputs.right = false;
        if(e.key === 'w' || e.key === 'ArrowUp') inputs.up = false;
        if(e.key === 'k') inputs.a = false;
        if(e.key === 'j') inputs.b = false;
    };

    function bootMatch() {
        p1.el = document.getElementById('main-player');
        p2.el = document.getElementById('p2');
        p2.el.style.display = 'flex';
        document.getElementById('design-lab').style.display = 'none';
        document.getElementById('hud').style.display = 'flex';
        gameActive = true;
    }

    function performAttack(attacker, victim, power) {
        if (attacker.isAtk) return;
        attacker.isAtk = true;
        attacker.el.classList.add('attacking');

        // Collision Check: Are they close enough and is the attacker facing the victim?
        const dist = Math.abs(attacker.x - victim.x);
        const correctDir = (attacker.x < victim.x && attacker.dir === 1) || (attacker.x > victim.x && attacker.dir === -1);

        if (dist < 60 && correctDir) {
            victim.hp -= power;
            victim.x += attacker.dir * (power > 5 ? 30 : 10); // Knockback
            document.getElementById('game-viewport').classList.add('hit');
            setTimeout(() => document.getElementById('game-viewport').classList.remove('hit'), 100);
            if(window.navigator.vibrate) window.navigator.vibrate(power > 5 ? 50 : 20);
        }

        setTimeout(() => {
            attacker.isAtk = false;
            attacker.el.classList.remove('attacking');
            updateHP();
        }, power > 5 ? 400 : 200);
    }

    function updateHP() {
        document.getElementById('hp1').style.width = Math.max(0, p1.hp) + '%';
        document.getElementById('hp2').style.width = Math.max(0, p2.hp) + '%';
        if (p2.hp <= 0) { alert("VICTORY: SYSTEM_PURGED"); location.reload(); }
        if (p1.hp <= 0) { alert("DEFEAT: DATA_LOST"); location.reload(); }
    }

    function physics() {
        if (gameActive) {
            // P1 Movement
            if (inputs.left) { p1.x -= 3; p1.dir = -1; }
            if (inputs.right) { p1.x += 3; p1.dir = 1; }
            if (inputs.up && !p1.isJump) { p1.vy = -12; p1.isJump = true; }
            if (inputs.a) performAttack(p1, p2, 12);
            if (inputs.b) performAttack(p1, p2, 5);

            // CPU AI
            if (p2.x > p1.x + 50) { p2.x -= 1.5; p2.dir = -1; }
            else if (p2.x < p1.x - 50) { p2.x += 1.5; p2.dir = 1; }
            else if (Math.random() > 0.98) performAttack(p2, p1, 5);

            // Gravity & Bounds
            [p1, p2].forEach(p => {
                p.y -= p.vy; p.vy += 0.7;
                if (p.y <= 0) { p.y = 0; p.vy = 0; p.isJump = false; }
                p.x = Math.max(0, Math.min(260, p.x));
                // Render
                p.el.style.transform = `translate(${p.x}px, ${-p.y}px) scaleX(${p.dir})`;
            });
        }
        requestAnimationFrame(physics);
    }

    physics();
</script>
</body>
</html>
